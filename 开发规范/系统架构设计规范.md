### 一、系统部署环境

1. 【推荐】系统应尽可能的部署在云端服务，采用SaaS/Paas来提供对外的服务

2. 【推荐】系统应尽可能采用Linux + Redis + MySQL，可以有效的降低统一维护成本

3. 【强制】系统需要采用三层架构设计，分层部署

![image](https://i.loli.net/2021/04/14/BueDyN7lPEM9d6p.png) 

4. 【推荐】系统如果需要使用Windows服务器，则生产与准生产数据库必须使用单独的MSSQL数据库，且应用服务器必须支持HA模式。

5. 【强制】对于云端服务必须提供相对应的部署与维护文档，开发测试环境原则上由第三方做部署，准生产与生产环境必须由如新工程师团队做部署。



### 二、服务器配置相关

1. 【推荐】高并发服务器建议调小TCP协议的time_wait超时时间。 

说明：操作系统默认240秒后，才会关闭处于time_wait状态的连接，在高并发访问下，服务器端会因为处于time_wait的连接数太多，可能无法建立新的连接，所以需要在服务器上调小此等待值。 

2. 【推荐】调大服务器所支持的最大文件句柄数（File Descriptor，简写为fd）。 

说明：主流操作系统的设计是将TCP/UDP连接采用与文件一样的方式去管理，即一个连接对应于一个fd。主流的linux服务器默认所支持最大fd数量为1024，当并发连接数很大时很容易因为fd不足而出现"open too many files"错误，导致新的连接无法建立。 建议将linux服务器所支持的最大句柄数调高数倍（与服务器的内存数量相关）。 

3. 【推荐】给JVM环境参数设置-XX:+HeapDumpOnOutOfMemoryError参数，让JVM碰到OOM场景时输出dump信息。 

说明：OOM的发生是有概率的，甚至相隔数月才出现一例，出错时的堆内信息对解决问题非常有帮助。 

4. 【推荐】在线上生产环境，JVM的Xms和Xmx设置一样大小的内存容量，避免在GC 后调整堆大小带来的压力。 

5. 【推荐】服务器内部重定向使用forward；外部重定向地址使用URL拼装工具类来生成，否则会带来URL维护不一致的问题和潜在的安全风险。

6. 【推荐】对于使用自建tomcat服务的应用，请注意连接池的设定

```xml
<connector executor="tomcatThreadPool" 
port="8080" 
protocol="org.apache.coyote.http11.Http11NioProtocol"
connectionTimeout="20000"
redirectPort="8443"
enableLookups="false"
maxPostSize="10485760"
URIEncoding="UTF-8"
acceptCount="100"
acceptorThreadCount="2"
disableUploadTimeout="true"
maxConnections="10000"
SSLEnabled="false"/>
```

7. 【推荐】对于自建tomcat服务中的JVM参数优化

   参数说明：

   1）file.encoding 默认文件编码

   2）-Xmx1024m 设置JVM最大可用内存为1024MB

   3）-Xms1024m 设置JVM最小内存为1024m。此值可以设置与-Xmx相同，以避免每次垃圾回收完成后JVM重新分配内存。

   4）-XX:NewSize 设置年轻代大小

   5）XX:MaxNewSize 设置最大的年轻代大小

   6）-XX:PermSize 设置永久代大小

   7）-XX:MaxPermSize 设置最大永久代大小

   8）-XX:NewRatio=4:设置年轻代（包括Eden和两个Survivor区）与终身代的比值（除去永久代）。设置为4，则年轻代与终身代所占比值为1：4，年轻代占整个堆栈的1/5

   9）-XX:MaxTenuringThreshold=0：设置垃圾最大年龄，默认为：15。如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，可以提高效率。如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概论。

   10）-XX:+DisableExplicitGC这个将会忽略手动调用GC的代码使得 System.gc()的调用就会变成一个空调用，完全不会触发任何GC

   修改tomcat/bin/catalina.sh文件参数，以服务器内存为4-8G举例：

```
JAVA_OPTS="-Dfile.encoding=UTF-8 -server -Xms1024m -Xmx2048m -XX:NewSize=512m -XX:MaxNewSize=1024m -XX:PermSize=256m -XX:MaxPermSize=256m -XX:MaxTenuringThreshold=10 -XX:NewRatio=2 -XX:+DisableExplicitGC"
```

8. 【推荐】Linux系统核心调优

   File Descriptors的设置 ： 以服务器内存大小的10%来计算。可以使用下述脚本的输出的数值*0.1作为 file-max的值：

```
grep -r MemTotal /proc/meminfo | awk '{printf("%d",$2/10)}'
```