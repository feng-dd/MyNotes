

# ES开发规范 V1.0

## 一、基础规范

【强制】：禁止在生产环境的ES里进行压力测试。

【强制】：禁止在测试、开发环境直接连接生产环境的ES里进行测试。

【强制】：禁止在生产环境的ES里创建测试索引。

【强制】：禁止在ES上直接修改索引的Mapping结构，所有修改都应在mapping目录下对应的json文件进行修订 json文件修订好之后再通过Index重新构建Index进行修改。

【强制】：生产环境的ES、Kibana仅提供内网访问地址，不得提供公网访问地址。

【强制】：使用当前云厂商已经提供的ES大版本号一致的SDK版本和ES服务版本进行开发、测试以及生产使用，禁止使用过高或过低版本，以及发现存在有漏洞的版本。

【强制】：禁止在ES套用关系数据库表的关联表设计思维进行Index设计，因为ES不擅长做表关联查询。

【强制】：Java客户端在5.X版本必须使用Transport Client(解决性能问题)，6.X及以上版本使用 High Rest Client (避免 AWS 上 TCP 不能诱传）.

【强制】：禁止Index里面会用多个Type，因为6.x以后不再支持多个Type

## 二、命名规范

【强制】：Index、Aliases、Type的命名统一使用英文小写字母，并采用下划线分割，不得超过64 个字符。

【强制】：Field命名与Java类属性名的命名规则_致。

【强制】：Index、Aliases、Type、Field的命名禁止使用ES保留字。

【强制】：Aliases的命名规则：项目名称（缩写）+环境名+表名。

【建议】：Index的命名则：Aliases+生成日期0 

   正例：XX项目的商品表在生产环境中Index名：

【强制】：Index、Aliases、Type的命名统一使用名词的单数形式。

## 三、Index规范

【强制】：Index的字符集默认使用UTF-8。

【强制】：Index都必须与Aliases进行关联0

【强制】：Index的每个Shard不得超过30GB。

【强制】：单个Index数 据 规 模 必 须 控 制 在 1 个 亿Document内 。 如 数 据 规 模 超 过 1 个 亿Document及以上必须进行拆分为多个Index。

【建议】: Index拆分时，建议根据业务搜索关键字（租户/渠道/用户类型）进行拆分，如随时间推移而线性增长则优先考虑时间维度拆分。

【强制】：Index结构优先考虑扁平化，其次考虑嵌套结构，非特殊场景下禁止继续使用ES5.X父子和ES6.X的JOIN类型文档结构。

【强制】：Index内容设计按满足业务搜索场景为基准，搜索用不到的字段则不要写入Index。

【强制】：Document的ID应当采用业务唯一主键，不要使用ES自动生成的ID。（避免在ES出现重复记录）

【建议】: 单个Index的Primary Shard个数=k *数据节点个数。这里的k, 建 议 为 一 个 5 以内的整数值。当丨ndex数据规  模在很小时候，比如只有几十、几百MB左右的情况下建议只分配1〜2 

【强制】：为了保障生产环境生产的Index可用性，Index至少保留一对主副本，而且副本数量不要超过ES服务器的节点数

## 四、Mapping规范

【强制】：Index中的最大字段数（字段和对象映射以及字段别名都计入此限制）不得超过1000个。 

 (防止出现内存爆炸性能问题）

【强制】：Field的最大深度（以内部对象的数量来衡量）不超过20层。（防止出现内存爆炸性能问题）

【强制】：使用嵌套（nested）对象时，嵌套Field的数组元素不得超过50个，整个Index的嵌套数组总元素不得超过10000个。(防止出现内存爆炸性能问题）

【强制】：dynamic参数默认设置为false , Field的类型必须事先指定，特别是double和long类 型数字。由于ES自动映射是根据第一次遇到的字段内容来推断类型的，在遇到long和double型字段会受 

 到输入数值长度以及精度较短导致推断为int和float类型。(节约空间和提高写入速度）

【强制】：数字、日期类型在不需要区间统计场景下也是统一采用keyword进行映射。（提高查询速度和避免时区影响曰期正确性）

【强制】 ：Text类型的Field必须声明分词器，同时声明一个keyword字段进行存储。

【强制】：日期型字段，必须声明日期格式。Java在做JS〇N转换的时候，必须指定时区（例如：timezone="GMT+ 8 _ _ ) 。

 日期格式：yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis||strict_date_optional_time 

【强制】：_all参数默认设置为false。（节约空间和提高写入速度）

 如果在需要根据关键词来查找某条数据，但是无法明确要到哪个字段中去查时，才将该参数设置为 true。

【强制】：对于不作为搜索条件、排序、聚合相关的Field, 必 须 将 index和doc_value设置为 false。（节约空间和提高写入速度）



## 五、搜索规范

【强制】：搜索内容时，必须使用Index的Aliases进行搜索，而不是使用Index名进行搜索。

【强制】：wildcard / prefix query执行一个带有通配符*的长字符串查询时，字符串长度不得超过200个字符。

【建议】: 避免from+size深度翻页，建议使用主键偏移非分页偏移(SearchAfter)或游标(Scoll)进行查询。

【建议】: 慎用Elastic Search Script,而且使用脚本格式建议为painless。

 由于Elastic Search中文档的数量可能非常庞大，在使用脚本进行辅助查询的时候可能会出现脚本编写方式不对导致响应时间过长，这种情况我们应该使用Kibana中提供的分析工具来观察我们的查询语法。

【强制】：父子关联分页查询时，不得使用InnerHit进行关联Document—起返回，而是采用先按主文档分页查询后，再通过关联键进行二次查询，并在应用层面上进行封装后返回。

 由于Elastic Search中文档的数量可能非常庞大，InnerHit会将未分页前的大量文档在Elastic Search的堆内存中进行合并，从而导致堆内存过度紧张，频繁出现GC,严重影响性能。

【强制】：聚合总数量不超过10000个，以避免造成00M问题。

【强制】：禁止修改ES默认窗口结果集参数（max_result_wind〇w,默认值为10000)。（避免大量的数据被载入ES的堆内存中，造成堆内存过度紧张，频繁出现GC,甚至崩溃。）

【强制】：禁止match查询替代like (wildcard / prefix / regexp)查询。因为match查询不但会到Field进行分词，而且会对输入搜索关键字进行分词，从而会导致无法达到like查询结果。

 

## 六、流程规范

【强制】：所有的Index建立需要确定后才可以建立业务上线。

【强制】：所有的Index结构修改操作都需要评估：所改Index的已有数据量、重新构建Index性能。

【强制】：导入、导出大批量数据时必须提前通知运维协助观察。

【强制】：推广活动或上线新功能必须提前进行流量评估。

【强制】：**增量Index同步需要用MQ进行缓冲时，必须考虑数据顺序性影响，对于有顺序要求数据，请使用顺序消息进行处理。**

   例如：业务上对同一记录频繁更新，而且更新数据是有先后依赖关系时，如果采用无序MQ,就会发生关系错乱导致更新结果不正确。