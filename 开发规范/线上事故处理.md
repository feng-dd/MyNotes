# 20201225_MC Boost安全事故分析报告

## 一、故障发生时间、现象、影响及恢复

| **故障时间** | 2020年12月8日上午10时许              |
| ------------ | ------------------------------------ |
| **故障现象** | 用户可通过非正常途径重复领取点数奖励 |
| **故障恢复** | 2020年12月8日晚上10时许              |

##  二、故障处理过程

1. **故障排查分析**

   >  1）正常参与活动的流程
   >
   > 用户参与活动有两种渠道：
   >
   > 渠道1：用户使用的微信绑定过星享城账号，用户登录活动页即可通过微信openId找到对应的星享城账号，若满足条件即可领取奖励（条件1：该手机号、openId不存在参与记录。条件2：用户类型为PC、RC、游客）
   >
   > 渠道2：用户未曾使用微信绑定过星享城，或用户是游客身份需通过手机号、验证码方式验证后，方可进入活动，领取时需同样满足上述活动条件，才可进行领取奖励。
   >
   > 正常的奖励发放条件：在上述两种渠道满足活动条件的前提下，领取成功后会存入发放记录表，按照用户类型区分发放逻辑：
   >
   > A）PC 直接发放到账 
   >
   > B）RC 需进行开卡后发放到账 
   >
   > C）游客需进行注册并开卡后发放给到账  
   >
   > 2）问题产生流程
   >
   > 通过微信进入活动页，该用户的微信openId绑定过星享城的账号，且没有参与过活动的记录，且用户类型为一个PC用户，在用户扫码领奖发放记录时，以上校验条件均通过，点数发放到账成功，但通过该微信openId关联的用户数据缺少手机号字段，导致发放记录在保存时失败，从而没有记录用户的参与活动记录，用户下一次进入活动页时，依然可以绕过参与活动记录的校验，重复领取活动点数。

2. **修复方案**

   补充校验逻辑：在通过openId查询到星享城账户缺少手机号时，提示用户需前往星享城绑定手机号方可参与活动。 

3. **处理结果**

   通过代码修复后端手机号校验漏洞，当天通过ECC流程紧急上线，封堵了非法扫码获取点数的路径，并通过脚本导出之前产生非法点数的数据报表，再经业务热线沟通等方式收回点数。 

##  三、 故障原因分析

1. **历史数据不合规**

   正常情况下，星享城注册登录用户均需绑定手机号作为主要关联属性，但经初步调查，这次未绑定手机号的用户，可能是在星享城上线初期通过数据初始化统一导入的历史用户，存在手机号字段缺失，且这部分特殊用户数据在事故前并未引起各方重视。

2. **设计考虑不充分**

   针对上述提到的特殊用户数据情况，在需求调研，产品规划，原型设计，到技术上的概要设计，详细设计等阶段，均未被考虑到。在各个多方参与的设计评审乃至需求澄清阶段也均未有人能发现校验上的漏洞。 

3. **开发考虑不周全**

   在设计未考虑到的情况下，开发同学在编写代码时，根据经验应当对不同分支情况进行充分考虑并做代码兼容，发现设计遗漏的情形也应和产品等相关同学进行讨论确认，但此次开发同学和相关开发TL在开发以及代码评审过程中未能及时发现这个问题。 

4. **测试验收未覆盖**

   此次MC Boost S2版本云徙共编制相应测试用例82条，事后复盘用例中未涵盖手机号未绑定等特殊情况的测试用例，在用例评审及如新验收过程中，也未能覆盖相关情形。 

## 四、改善和改进工作

1. **加强数据质量管控**

   通过此次事故，针对类似问题数据，需要引起项目组重视，进一步评估现有系统中的数据质量问题，尤其需要梳理在之前遇到的线上问题中，由数据原因引起的问题分类，多记录多总结多分享多参考，对后续开发和迭代工作，起到预警作用。另外在有可能的情况下，逐步分批清理或修复问题数据，尤其是用户主数据相关，逐步管控和提高数据质量。

2. **规范设计流程和标准**

   在产品设计阶段，PD形成云徙内部项目和产品设计经验分析交流（初期预定每周一次），PD之间互相交流不同市场业务迭代，或者不同产品迭代的业务逻辑，产品设计思路，经验教训等，分享和拉通各PD之间的认识和知识共享，确保无论在哪个市场哪个项目遇到的问题，都能被其他项目所参考借鉴，进而避免因为信息不通而导致的各类问题。

   对于这次事故，PD会统一梳理三地不同登陆方式下的用户合法性校验方式（计划1月完成一版）。

   在研发阶段，进一步优化代码自查表内容，增加相关内容的增项自查以及相应开发规范的制定，同时强化代码评审的作用，将自查互查评审等环节充分落地到项目研发过程中，不为赶工期的开发而开发，给予开发合理充分的研发周期时间，以开发质量为导向，强化开发责任制。

3. **完善测试保障机制**

   由测试团队牵头，基于如新语雀线上问题记录，形成项目case库，并不断记录完善。产品，研发，测试团队可以定期进行审阅分享，吸取不同项目的经验，以避免重复相似的错误。同时定期召开测试内部分享会，互相交流项目经验，形成基准测试用例库，用来解决不同的项目中较为基础的安全性校验，确保基础性安全问题不遗漏。